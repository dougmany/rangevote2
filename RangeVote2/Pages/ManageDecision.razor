@page "/decision/{ballotIdParam}/manage"
@page "/ballot/{ballotIdParam}/manage"
@using RangeVote2.Data
@using Microsoft.AspNetCore.Components.Authorization
@inject IRangeVoteRepository Repository
@inject IShareService ShareService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Manage Decision - GroupChoice</PageTitle>

<h1>Manage Decision</h1>

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger">@errorMessage</div>
    <a href="/decisions" class="btn btn-secondary">Back to Decisions</a>
}
else if (decision != null)
{
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @(activeTab == "details" ? "active" : "")" @onclick='() => activeTab = "details"' href="javascript:void(0)">Details</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(activeTab == "choices" ? "active" : "")" @onclick='() => activeTab = "choices"' href="javascript:void(0)">Choices</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(activeTab == "sharing" ? "active" : "")" @onclick='() => activeTab = "sharing"' href="javascript:void(0)">Sharing</a>
        </li>
    </ul>

    @if (activeTab == "details")
    {
        <div class="card">
            <div class="card-body">
                <h3>Decision Details</h3>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-control" @bind="decision.Name" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" @bind="decision.Description" rows="3"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Close Date</label>
                            <input type="datetime-local" class="form-control" value="@(decision.CloseDate?.ToString("yyyy-MM-ddTHH:mm"))"
                                   @onchange="(e) => decision.CloseDate = string.IsNullOrEmpty(e.Value?.ToString()) ? null : DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" @bind="decision.Status">
                                <option value="@BallotStatus.Draft">Draft</option>
                                <option value="@BallotStatus.Open">Open</option>
                                <option value="@BallotStatus.Closed">Closed</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input" id="isPublicManage" @bind="decision.IsPublic" />
                    <label class="form-check-label" for="isPublicManage">
                        Make this decision public
                    </label>
                    <div class="form-text">Public decisions can be discovered and joined by anyone.</div>
                </div>
                <button class="btn btn-primary" @onclick="SaveDetails">Save Changes</button>
            </div>
        </div>
    }
    else if (activeTab == "choices")
    {
        <div class="card">
            <div class="card-body">
                <h3>Manage Choices</h3>

                @foreach (var choice in choices)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1">@choice.Name</h5>
                                    @if (!string.IsNullOrWhiteSpace(choice.Description))
                                    {
                                        <p class="text-muted mb-0">@choice.Description</p>
                                    }
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => DeleteChoice(choice.Id)">Remove</button>
                            </div>
                        </div>
                    </div>
                }

                <hr />

                <h4>Add New Choice</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" class="form-control" @bind="newChoice.Name" placeholder="Choice name" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" class="form-control" @bind="newChoice.Description" placeholder="Add details..." />
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" @onclick="AddChoice">Add Choice</button>
            </div>
        </div>
    }
    else if (activeTab == "sharing")
    {
        <div class="card mb-3">
            <div class="card-body">
                <h3>Share Links</h3>
                <p class="text-muted">Create links to share this decision with others.</p>

                <div class="mb-4">
                    <div class="d-flex gap-2">
                        <select class="form-control" style="max-width: 200px;" @bind="newLinkPermission">
                            <option value="@ShareLinkPermission.View">View Only</option>
                            <option value="@ShareLinkPermission.Vote">Can Vote</option>
                            <option value="@ShareLinkPermission.Admin">Admin Access</option>
                        </select>
                        <button class="btn btn-primary" @onclick="CreateShareLink">Create Link</button>
                    </div>
                </div>

                @if (shareLinks.Any(l => l.IsActive))
                {
                    <h5>Active Links</h5>
                    @foreach (var link in shareLinks.Where(l => l.IsActive))
                    {
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div style="flex: 1;">
                                        <strong>@link.Permission Permission</strong>
                                        <small class="text-muted d-block">Used @link.UseCount times</small>
                                        <input type="text" class="form-control mt-2" readonly value="@ShareService.FormatShareUrl(link.ShareToken, NavigationManager)" />
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="() => DeactivateLink(link.Id)">Deactivate</button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">No active share links.</p>
                }
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h3>Invite by Email</h3>

                <div class="d-flex gap-2 mb-4">
                    <input type="email" class="form-control" @bind="inviteEmail" placeholder="user@example.com" />
                    <select class="form-control" style="max-width: 150px;" @bind="invitePermission">
                        <option value="@UserPermission.Viewer">Viewer</option>
                        <option value="@UserPermission.Voter">Voter</option>
                        <option value="@UserPermission.Editor">Editor</option>
                        <option value="@UserPermission.Admin">Admin</option>
                    </select>
                    <button class="btn btn-primary" @onclick="InviteUser">Invite</button>
                </div>

                @if (permissions.Any())
                {
                    <h5>People with Access</h5>
                    @foreach (var perm in permissions)
                    {
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <strong>@(perm.InvitedEmail ?? "Unknown")</strong>
                                <span class="text-muted"> - @perm.Permission</span>
                                @if (perm.AcceptedAt.HasValue)
                                {
                                    <span class="badge bg-success ms-2">Accepted</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning ms-2">Pending</span>
                                }
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => RevokePermission(perm.Id)">Remove</button>
                        </div>
                    }
                }
            </div>
        </div>
    }

    <div class="mt-4 d-flex gap-2">
        <a href="/decisions" class="btn btn-secondary">Back to Decisions</a>
        <a href="/vote?ballotId=@decisionId" class="btn btn-primary">Vote</a>
        <a href="/result?ballotId=@decisionId" class="btn btn-outline-secondary">Results</a>
        @if (canDelete)
        {
            <button class="btn btn-danger ms-auto" @onclick="DeleteDecision">Delete Decision</button>
        }
    </div>
}

@code {
    [Parameter]
    public string? ballotIdParam { get; set; }

    private Guid decisionId;
    private BallotMetadata? decision;
    private List<BallotCandidate> choices = new();
    private List<BallotShareLink> shareLinks = new();
    private List<BallotPermission> permissions = new();

    private CreateCandidateModel newChoice = new();
    private ShareLinkPermission newLinkPermission = ShareLinkPermission.Vote;
    private string inviteEmail = "";
    private UserPermission invitePermission = UserPermission.Voter;

    private string activeTab = "details";
    private bool isLoading = true;
    private string? errorMessage;
    private bool canDelete = false;
    private Guid userId;

    protected override async Task OnInitializedAsync()
    {
        if (!Guid.TryParse(ballotIdParam, out decisionId))
        {
            errorMessage = "Invalid decision ID.";
            isLoading = false;
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null)
            {
                userId = Guid.Parse(userIdClaim.Value);
            }
        }

        await LoadDecision();
    }

    private async Task LoadDecision()
    {
        try
        {
            decision = await Repository.GetBallotMetadataAsync(decisionId);
            if (decision == null)
            {
                errorMessage = "Decision not found.";
                return;
            }

            var canAdmin = await Repository.CanUserAdminAsync(decisionId, userId);
            var canEdit = await Repository.CanUserEditAsync(decisionId, userId);

            if (!canAdmin && !canEdit)
            {
                errorMessage = "You do not have permission to manage this decision.";
                return;
            }

            canDelete = decision.OwnerId == userId;

            choices = await Repository.GetCandidatesAsync(decisionId);
            shareLinks = await Repository.GetShareLinksAsync(decisionId);
            permissions = await Repository.GetBallotPermissionsAsync(decisionId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading decision: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveDetails()
    {
        try
        {
            if (decision != null)
            {
                await Repository.UpdateBallotAsync(decision);
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving: {ex.Message}";
        }
    }

    private async Task AddChoice()
    {
        if (string.IsNullOrWhiteSpace(newChoice.Name))
        {
            errorMessage = "Choice name is required.";
            return;
        }

        try
        {
            await Repository.AddCandidateAsync(decisionId, newChoice);
            newChoice = new CreateCandidateModel();
            await LoadDecision();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding choice: {ex.Message}";
        }
    }

    private async Task DeleteChoice(Guid choiceId)
    {
        try
        {
            await Repository.DeleteCandidateAsync(choiceId);
            await LoadDecision();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error removing choice: {ex.Message}";
        }
    }

    private async Task CreateShareLink()
    {
        try
        {
            await Repository.CreateShareLinkAsync(decisionId, newLinkPermission, userId);
            await LoadDecision();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating share link: {ex.Message}";
        }
    }

    private async Task DeactivateLink(Guid linkId)
    {
        try
        {
            await Repository.DeactivateShareLinkAsync(linkId);
            await LoadDecision();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deactivating link: {ex.Message}";
        }
    }

    private async Task InviteUser()
    {
        if (string.IsNullOrWhiteSpace(inviteEmail))
        {
            errorMessage = "Email is required.";
            return;
        }

        try
        {
            await Repository.InviteUserAsync(decisionId, inviteEmail, invitePermission, userId);
            inviteEmail = "";
            await LoadDecision();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inviting user: {ex.Message}";
        }
    }

    private async Task RevokePermission(Guid permissionId)
    {
        try
        {
            await Repository.RevokePermissionAsync(permissionId);
            await LoadDecision();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error removing access: {ex.Message}";
        }
    }

    private async Task DeleteDecision()
    {
        if (!canDelete) return;

        try
        {
            await Repository.DeleteBallotAsync(decisionId, userId);
            NavigationManager.NavigateTo("/decisions");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting decision: {ex.Message}";
        }
    }
}
